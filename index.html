<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Planville AI Chatbot</title>
  <link rel="stylesheet" href="style.css" />

  <!-- 🔧 CONFIG & API: WAJIB PALING ATAS -->
  <script src="config.js"></script>
  <script src="api_client.js"></script>
</head>
<body>

  <!-- 📌 Sidebar FAQ -->
  <div class="faq-sidebar">
    <h2>Frequently Asked Questions</h2>
    <ul id="faq-list"></ul>
  </div>

  <!-- 💬 Main Chatbot UI -->
  <div class="chatbot-container">
    <div class="chatbot-header">
      <img src="planville-logo.png" alt="Planville Logo" class="chatbot-logo"/>
      <h1>Chat with Planville AI</h1>
      <label class="switch">
        <input type="checkbox" id="modeToggle" />
        <span class="slider"></span>
      </label>
    </div>

    <div id="chatbot-log"></div>
    <div id="typing-bubble" class="chatbot-message bot-message typing-bubble" style="display:none">...</div>

    <form id="chatbot-form">
      <input type="text" id="chatbot-input" placeholder="Type your question..." autocomplete="off"/>
      <button type="submit">💬</button>
    </form>

    <div class="language-switcher">
      <label for="langSwitcher">🌐 Language:</label>
      <select id="langSwitcher">
        <option value="de">🇩🇪 Deutsch</option>
        <option value="en">🇬🇧 English</option>
      </select>
    </div>
  </div>

  <!-- 📋 CONFIGURATOR FORM (SIMPLE) -->
  <div id="configForm" class="config-form" style="display: none;">
    <h2>Produkt wählen</h2>
    <select id="productSelect">
      <option value="">Bitte auswählen</option>
      <option value="PV-Anlage">PV-Anlage</option>
      <option value="Dachsanierung">Dachsanierung</option>
      <option value="Wärmepumpe">Wärmepumpe</option>
      <option value="Klimaanlage">Klimaanlage</option>
      <option value="Speicherlösung">Speicherlösung</option>
    </select>

    <h2>Kontaktdaten</h2>
    <input type="text" id="vorname" placeholder="Vorname" required />
    <input type="text" id="nachname" placeholder="Nachname" required />
    <input type="tel" id="telefon" placeholder="Telefonnummer" required />
    <button id="submitConfig">Absenden</button>
  </div>

  <!-- 🎯 FORM WIZARD (DOUBLE CLICK MODE) -->
  <div class="form-wizard" id="form-wizard" style="display:none">
    <h2>Jetzt starten</h2>
    <label for="product-choice">Produkt wählen:</label>
    <select id="product-choice">
      <option value="Photovoltaik">Photovoltaik</option>
      <option value="Wärmepumpe">Wärmepumpe</option>
      <option value="Klimaanlage">Klimaanlage</option>
      <option value="Dachsanierung">Dachsanierung</option>
    </select>

    <label for="fname">Vorname:</label>
    <input type="text" id="fname" required />

    <label for="lname">Nachname:</label>
    <input type="text" id="lname" required />

    <label for="phone">Telefonnummer:</label>
    <input type="tel" id="phone" required />

    <button onclick="submitLead()">Absenden</button>
  </div>

  <!-- 🍪 Cookie Consent (sederhana) -->
  <div id="cookie-banner" class="cookie-popup" style="display:none">
    <p id="cookie-message">Diese Website verwendet Cookies, um Ihr Erlebnis zu verbessern.</p>
    <div class="cookie-buttons">
      <button onclick="acceptCookies()">Akzeptieren</button>
      <button onclick="rejectCookies()">Ablehnen</button>
      <button onclick="openSettings()">Einstellungen</button>
    </div>
  </div>

  <!-- 🧠 Misc helpers & tracking -->
  <script>
    // Ekspor bahasa agar dipakai file lain (lead_form.js, dsb)
    function getCurrentLang(){
      const el = document.getElementById("langSwitcher");
      return el ? el.value : (window.CONFIG?.LANG_DEFAULT || "de");
    }
    window.getCurrentLang = getCurrentLang;

    // GA4 (opsional): aktif kalau user accept cookies
    function enableGTM() {
      if (!CONFIG?.GTM_ID) return;
      const script = document.createElement("script");
      script.src = "https://www.googletagmanager.com/gtag/js?id=" + CONFIG.GTM_ID;
      script.async = true;
      document.head.appendChild(script);

      window.dataLayer = window.dataLayer || [];
      function gtag(){ dataLayer.push(arguments); }
      window.gtag = gtag;
      gtag('js', new Date());
      gtag('config', CONFIG.GTM_ID);
    }

    function trackChatEvent(question, lang) {
      if (typeof gtag !== "undefined") {
        gtag('event', 'chat_message', { event_category: 'chatbot', event_label: question, language: lang });
      }
      window.api?.track?.({event:"chat_message", question, lang}).catch(()=>{});
    }

    function trackFAQClick(text) {
      const selectedLang = getCurrentLang();
      if (typeof gtag !== "undefined") {
        gtag('event', 'faq_click', { event_category: 'faq', event_label: text, language: selectedLang });
      }
      window.api?.track?.({event:"faq_click", text, lang:selectedLang}).catch(()=>{});
    }

    function trackConfigStart() {
      if (typeof gtag !== "undefined") {
        gtag('event', 'start_config_click', { event_category: 'konfigurator', event_label: 'Jetzt starten' });
      }
      window.api?.track?.({event:"start_config_click"}).catch(()=>{});
    }

    function trackConfigSubmit(product) {
      if (typeof gtag !== "undefined") {
        gtag('event', 'config_submit_success', { event_category: 'konfigurator', event_label: product });
      }
      window.api?.track?.({event:"config_submit_success", product}).catch(()=>{});
    }

    // 🍪 Cookie consent minimal
    function acceptCookies() {
      localStorage.setItem("cookieConsent", "accepted");
      document.getElementById("cookie-banner").style.display = "none";
      enableGTM();
    }
    function rejectCookies() {
      localStorage.setItem("cookieConsent", "rejected");
      document.getElementById("cookie-banner").style.display = "none";
    }
    function openSettings() {
      alert("Einstellungsseite ist noch in Entwicklung.");
    }
  </script>

  <!-- 🤖 Chat logics ringan (greeting & CTA) -->
  <script>
    function appendMessage(html, who="bot"){
      const log = document.getElementById("chatbot-log");
      const div = document.createElement("div");
      div.className = `chatbot-message ${who}-message`;
      div.innerHTML = html;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }
    function scrollToBottom(){
      const log = document.getElementById("chatbot-log");
      log.scrollTop = log.scrollHeight;
    }

    function showProductOptions() {
      const productOptions = [
        "Photovoltaikanlage ☀️",
        "Klimaanlage ❄️",
        "Wärmepumpe 🔥",
        "Mieterstrom 🏠",
        "Dachsanierung 🛠️"
      ];
      const container = document.createElement("div");
      container.className = "product-options";

      productOptions.forEach(product => {
        const button = document.createElement("button");
        button.type = "button";
        button.innerText = product;
        button.className = "product-button";
        button.onclick = () => handleProductSelection(product);
        container.appendChild(button);
      });

      document.getElementById("chatbot-log").appendChild(container);
      scrollToBottom();
    }

    function handleProductSelection(product) {
      appendMessage(product, "user");
      setTimeout(() => {
        appendMessage(`Was möchten Sie genau zu <b>${product}</b> wissen oder erreichen?`, "bot");
      }, 500);
    }

    function handleFinalUserInput(userText) {
      appendMessage(userText, "user");
      setTimeout(() => {
        appendMessage(
          `Vielen Dank! 😊 Unser Team hilft Ihnen gerne weiter.<br><br>
          Für eine persönliche Beratung klicken Sie bitte auf den Button unten:`,
          "bot"
        );
        const btn = document.createElement("a");
        btn.href = CONFIG?.CTA_URL || "https://planville.de/kontakt";
        btn.target = "_blank";
        btn.className = "cta-button";
        btn.innerText = (getCurrentLang()==="de") ? "💬 Jetzt Kontakt aufnehmen" : "💬 Contact us";
        document.getElementById("chatbot-log").appendChild(btn);
        scrollToBottom();
      }, 800);
    }

    // onload init
    window.addEventListener("load", () => {
      const consent = localStorage.getItem("cookieConsent");
      if (!consent) document.getElementById("cookie-banner").style.display = "block";
      else if (consent === "accepted") enableGTM();

      // optional buttons (kalau ada)
      document.getElementById("startConfigBtn")?.addEventListener("click", () => {
        document.getElementById("configForm").style.display = "block";
        document.getElementById("startConfigBtn").style.display = "none";
        trackConfigStart();
      });
      document.getElementById("startConfigBtn")?.addEventListener("dblclick", () => {
        document.getElementById("form-wizard").style.display = "block";
        document.getElementById("startConfigBtn").style.display = "none";
      });

      document.getElementById("submitConfig").addEventListener("click", async () => {
        const product = document.getElementById("productSelect").value;
        const vorname = document.getElementById("vorname").value.trim();
        const nachname = document.getElementById("nachname").value.trim();
        const telefon = document.getElementById("telefon").value.trim();

        if (!product || !vorname || !nachname || !telefon) {
          alert("Bitte alle Felder ausfüllen.");
          return;
        }

        const payload = { vorname, nachname, telefon, product };

        try {
          // contoh stub post; ganti dengan endpoint kamu jika perlu
          await window.api.track({event:"config_submit_click", payload});
          alert("Danke! Wir haben Ihre Anfrage erhalten.");
          trackConfigSubmit(product);
          document.getElementById("configForm").reset();
          document.getElementById("configForm").style.display = "none";
        } catch (err) {
          console.error(err);
          alert("Serverfehler. Bitte später erneut versuchen.");
        }
      });

      // ✅ Initial Bot Greeting
      setTimeout(() => {
        const hello = (getCurrentLang()==="de")
          ? "Hallo! 👋 Was kann ich für Sie tun?<br>Bitte wählen Sie ein Thema:"
          : "Hi! 👋 How can I help you today?<br>Please choose a topic:";
        appendMessage(hello, "bot");
        showProductOptions();
      }, 400);
    });
  </script>

  <!-- 🔠 i18n & lainnya (jika kamu pakai) -->
  <script src="i18n_privacy.js"></script>
  <!-- <script src="privacy_consent.js"></script>  --> <!-- optional: hanya jika file-nya clean -->

  <!-- 🔩 Funnel + Guardrails + CTA -->
  <script src="funnel_engine_v2.js"></script>
  <script src="ai_guardrails_v2.js"></script>
  <script src="schedule_stub.js"></script>
  <script src="contact_cta.js"></script>

  <!-- 📮 Lead form & auto-open hook -->
  <script src="lead_form.js"></script>
  <script src="funnel_hooks.js"></script>

  <!-- 🤖 Chat engine utama (pastikan pakai api.aiAnswer / stream) -->
  <script src="chatbot.js" defer></script>
</body>
</html>
